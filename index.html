<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quiz Sign-In (UCSC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --ucsc-blue: #003262;
      --ucsc-gold: #fca321;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f6f8fb;
      color: #202124;
    }
    .wrap {
      max-width: 560px;
      margin: 8vh auto;
      background: #fff;
      border: 1px solid #e4e7eb;
      border-radius: 12px;
      padding: 24px 28px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 1.75rem;
      color: var(--ucsc-blue);
    }
    p.lead {
      margin: 0 0 18px;
      color: #5f6368;
    }
    .status {
      margin-top: 16px;
      font-weight: 600;
    }
    .status.ok { color: #188038; }
    .status.err { color: #d93025; }
    .footer {
      margin-top: 24px;
      font-size: .9rem;
      color: #5f6368;
    }
    .footer code { background: #f1f3f4; padding: 2px 6px; border-radius: 4px; }
    .badge {
      display:inline-block; margin-bottom:12px; padding:4px 8px;
      border-radius:999px; font-weight:700; color:#fff; background:var(--ucsc-gold);
      font-size:.8rem; letter-spacing:.02em;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <span class="badge">UCSC Quiz</span>
    <h1>Sign in with your UCSC Google account</h1>
    <p class="lead">You must use an email ending in <strong>@ucsc.edu</strong>.</p>

    <!-- GIS renders the button into this div -->
    <div id="buttonDiv" style="margin:18px 0;"></div>

    <!-- Status / errors -->
    <div id="status" class="status" role="status" aria-live="polite"></div>

    <!-- Invisible POST form to your Apps Script quiz -->
    <form id="postForm" method="POST" action="QUIZ_APPS_SCRIPT_URL" style="display:none;">
      <input type="hidden" name="credential" id="cred" />
    </form>
  </div>

  <script>
    // ===== CONFIG =====
    const CLIENT_ID = "482670064981-s7ms14pvs5piheulngtffjqn8sbq6j0c.apps.googleusercontent.com"; // your existing client id
    const QUIZ_URL  = "https://script.google.com/macros/s/AKfycbyL5Ckr8ed3RHPiMoZlaTb2PSZ47HDSpjJX-z3GWHaLnzlKUL8zv-_R4D88DA9qQu-a/exec"; // <-- replace with your Apps Script /exec URL

    // Show current origin for debugging
    document.getElementById("origin").textContent = window.location.origin;

    // Initialize GIS and render the button
    window.onload = function () {
      if (!CLIENT_ID || CLIENT_ID.indexOf(".apps.googleusercontent.com") === -1) {
        setStatus("Missing/invalid CLIENT_ID.", true);
        return;
      }
      if (!QUIZ_URL || !/^https:\/\/script\.google\.com\/macros\/s\/.+\/exec$/.test(QUIZ_URL)) {
        setStatus("Replace QUIZ_APPS_SCRIPT_URL with your Apps Script /exec URL.", true);
        return;
      }

      google.accounts.id.initialize({
        client_id:   CLIENT_ID,
        ux_mode:     "popup",
        auto_select: true,      // pick last used account when possible
        hd:          "ucsc.edu",// hint domain for account chooser
        callback:    onCredential
      });

      google.accounts.id.renderButton(
        document.getElementById("buttonDiv"),
        { theme: "outline", size: "large", type: "standard" }
      );
    };

    // Handle the credential (JWT) from GIS
    function onCredential(response) {
      try {
        const token = response.credential;
        const { email, hd } = parseEmailFromJWT(token);

        // Client-side guard: must be UCSC email (email OR hd claim)
        const okDomain = (email && /@ucsc\.edu$/i.test(email)) || (String(hd || "").toLowerCase() === "ucsc.edu");
        if (!okDomain) {
          setStatus("Please sign in with a @ucsc.edu account.", true);
          // Optional: revoke the selected account so the chooser appears next time
          if (email) {
            try { google.accounts.id.revoke(email, () => {}); } catch (e) {}
          }
          return;
        }

        setStatus("✅ Verified — redirecting to the quiz…", false);

        // POST the ID token to Apps Script quiz (doPost expects 'credential')
        const form = document.getElementById("postForm");
        document.getElementById("cred").value = token;
        form.action = QUIZ_URL;
        form.submit();
      } catch (err) {
        setStatus("Sign-in failed: " + (err && err.message ? err.message : err), true);
      }
    }

    // Utility: decode JWT payload (base64url) to get email/hd
    function parseEmailFromJWT(idToken) {
      const parts = idToken.split(".");
      if (parts.length !== 3) throw new Error("Bad token format");
      const payload = JSON.parse(base64UrlDecode(parts[1]));
      return {
        email: (payload.email || "").toLowerCase(),
        hd: payload.hd || ""
      };
    }
    function base64UrlDecode(str) {
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4; if (pad) str += "=".repeat(4 - pad);
      const decoded = atob(str);
      // handle unicode
      const esc = decoded.split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("");
      return decodeURIComponent(esc);
    }

    function setStatus(msg, isError) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.classList.toggle("ok", !isError);
      el.classList.toggle("err", !!isError);
    }
  </script>
</body>
</html>
